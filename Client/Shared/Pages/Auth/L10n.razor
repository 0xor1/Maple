@using Dnsk.Client.Lib
@using System.Text.RegularExpressions
@using Common
@using Dnsk.I18n
@using AuthValidator = Dnsk.Client.Lib.AuthValidator
@using S = Dnsk.I18n.Strings
<div class="root col g-1 p-1">
    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H2" class="m-t-0">
        @L.S(Strings.L10n)
    </RadzenText>
    <RadzenTemplateForm
        TItem="Model"
        Data="_model"
        Submit="Do"
        class="flx col g-1 ai-s">
        <div class="flx col ai-s">
            <RadzenLabel class="m-b-0q" Component="Lang" Text="Language"/>
            <RadzenDropDown Name="Lang" AllowClear=false TValue=string 
                            Data=Strings.SupportedLangs 
                            TextProperty="NativeName" ValueProperty="Code"
                            @bind-Value=@_model.Lang />
        </div>
        <div class="flx col ai-s">
            <RadzenLabel class="m-b-0q" Component="Date" Text="Date Format"/>
            <RadzenDropDown Name="Date" AllowClear=false TValue=string 
                            Data=Strings.SupportedDateFmts 
                            ValueProperty="Value"
                            @bind-Value=@_model.DateFmt />
        </div>
        <div class="flx col ai-s">
            <RadzenLabel class="m-b-0q" Component="Time" Text="Time Format"/>
            <RadzenDropDown Name="Time" AllowClear=false TValue=string 
                            Data=Strings.SupportedTimeFmts 
                            ValueProperty="Value"
                            @bind-Value=@_model.TimeFmt />
        </div>
        <RadzenButton ButtonType="ButtonType.Submit" BusyText="Updating" IsBusy="_doing" Text="Update" Disabled="!CanDo"/>
    </RadzenTemplateForm>
</div>

@inject IAuthService Auth;
@code{

    record Model
    {
        public string Lang { get; set; } = Strings.DefaultLang;
        public string DateFmt { get; set; } = Strings.DefaultDateFmt;
        public string TimeFmt { get; set; } = Strings.DefaultTimeFmt;
    }

    private bool CanDo => _model != _initialValues && !_doing;

    private Session _session = new (); 
    private Model _model = new (); 
    private Model _initialValues = new (); 
    private bool _doing = false;

    protected override async Task OnInitializedAsync()
    {
        _session = await Auth.GetSession();
        _model.Lang = _session.Lang;
        _model.DateFmt = _session.DateFmt;
        _model.TimeFmt = _session.TimeFmt;
        _initialValues.Lang = _session.Lang;
        _initialValues.DateFmt = _session.DateFmt;
        _initialValues.TimeFmt = _session.TimeFmt;
    }

    private async Task Do()
    {
        _doing = true;
        try
        {
            var ses = await Auth.SetL10n(_model.Lang, _model.DateFmt, _model.TimeFmt);
            _initialValues.Lang = ses.Lang;
            _initialValues.DateFmt = ses.DateFmt;
            _initialValues.TimeFmt = ses.TimeFmt;
        }
        catch
        {
            // use empty catch to avoid having to
            // call StatHasChanged on errors
        }
        _doing = false;
    }

    private void LangSelected(object val)
    {
        _model.Lang = ((Lang)val).Code;
    }
}